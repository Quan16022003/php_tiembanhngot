{% set page = 'products' %}
{% extends './layout.twig' %}
{% block content %}
    <head>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
        <title>
            {% block title %}Sản phẩm{% endblock %}
        </title>
        <link rel="stylesheet" href="/public/css/global.css">
    </head>
    <div class="container-fluid overflow-auto">
        <div class="row mb-3">
            <div class="col-md-6">
                <form id="search-form" class="form-inline">
                    <div class="input-group">
                        <input type="text" class="form-control" id="search-input"
                               placeholder="Nhập từ khóa tìm kiếm">

                    </div>
                </form>
            </div>
            <div class="col-md-6 text-md-right">
                <a href="/admin/products/create" class="btn btn-success">Create</a>
                <a href="/admin/products/add" class="btn btn-success">Import from CSV</a>
                <a href="/admin/products/exportToCSV" class="btn btn-success">Export to CSV</a>
            </div>
        </div>
        <div class="row rounded">
            <div class="col ">
                <table class="datatables-products table border-top dataTable no-footer dtr-column collapsed">
                    <thead>
                    <tr>
                        <th onclick="sortTable(0)">ID</th>
                        <th onclick="sortTable(1)">Tên sản phẩm</th>
                        <th onclick="sortTable(2)">Loại</th>
                        <th onclick="sortTable(3)">Giá</th>
                        <th onclick="sortTable(4)">Giảm giá</th>
                        <th onclick="sortTable(5)">Tồn kho</th>
                        <th>Trạng thái</th>
                        <th onclick="sortTable(7)">Lượt xem</th>
                        <th>Thao tác</th>
                    </tr>
                    </thead>
                    <tbody id="results-body">
                    {% for product in products %}
                        <tr>
                            <td>{{ product.id }}</td>
                            <td>{{ product.name }}</td>
                            {% for category in categories %}
                                {% if category.id == product.category_id %}
                                    <td>{{ category.name }}</td>
                                {% endif %}
                            {% endfor %}
                            <td>{{ product.price }}</td>
                            <td>{{ product.discount }}</td>
                            <td>{{ product.stock }}</td>
                            <td>
                                <div class="progress">
                                    <div class="progress-bar progress-bar-animated progress-bar-striped bg-success"
                                         role="progressbar"
                                         style="width: {{ product.stock }}%">
                                    </div>
                                </div>
                            </td>
                            <td>{{ product.view }}</td>
                            <td class="operation-button">
                                <button class="btn btn-info btn-warning"
                                        onclick="editProduct('{{ product.id }}')">
                                    Sửa
                                </button>
                                <button class="btn btn-danger"
                                        onclick="deleteProduct('{{ product.id }}')">Xóa
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% for i in 1..totalPages %}
                            <li class="page-item {% if i == currentPage %}active{% endif %}">
                                <a class="page-link pagination-link" href="#" data-page="{{ i }}">{{ i }}</a>
                            </li>
                        {% endfor %}
                    </ul>
                </nav>
            </div>
        </div>
    </div>
    <style>
        td {
            white-space: nowrap;
            word-break: break-word;
            max-width: fit-content;
        }

        th {
            cursor: pointer;
        }
    </style>

{% endblock %}
{% block scripts %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script>
        // Sử dụng jQuery để xử lý sự kiện click trên các liên kết phân trang
        $(document).on('click', '.pagination-link', function (event) {
            event.preventDefault();
            var page = $(this).data('page');
            $.ajax({
                url: '/admin/products?page=' + page,
                method: 'GET',
                success: function (response) {
                    // Cập nhật nội dung của trang với dữ liệu mới
                    $('body').html(response);
                },
                error: function (xhr, status, error) {
                    // Xử lý lỗi nếu có
                    console.error('Error:', error);
                }
            });
        });


        let sortStates = {}; // Lưu trữ trạng thái sắp xếp cho mỗi cột

        // Hàm sắp xếp bảng theo cột
        function sortTable(columnIndex) {
            let table, rows, switching, i, x, y, shouldSwitch;
            table = document.querySelector(".table");
            switching = true;

            // Kiểm tra nếu đã có trạng thái sắp xếp cho cột này
            if (!sortStates[columnIndex]) {
                sortStates[columnIndex] = "asc"; // Nếu không, mặc định là sắp xếp tăng dần
            } else {
                // Đảo ngược trạng thái sắp xếp nếu đã tồn tại
                sortStates[columnIndex] = sortStates[columnIndex] === "asc" ? "desc" : "asc";
            }

            while (switching) {
                switching = false;
                rows = table.rows;
                for (i = 1; i < (rows.length - 1); i++) {
                    shouldSwitch = false;
                    x = rows[i].getElementsByTagName("td")[columnIndex];
                    y = rows[i + 1].getElementsByTagName("td")[columnIndex];
                    let xValue = isNaN(parseFloat(x.innerHTML)) ? x.innerHTML.toLowerCase() : parseFloat(x.innerHTML);
                    let yValue = isNaN(parseFloat(y.innerHTML)) ? y.innerHTML.toLowerCase() : parseFloat(y.innerHTML);

                    // Sắp xếp tăng dần hoặc giảm dần tùy thuộc vào trạng thái
                    if ((sortStates[columnIndex] === "asc" && xValue > yValue) || (sortStates[columnIndex] === "desc" && xValue < yValue)) {
                        shouldSwitch = true;
                        break;
                    }
                }
                if (shouldSwitch) {
                    rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
                    switching = true;
                }
            }
        }

        // ADD PRODUCT FORM
        function openAddProductPage() {
            window.location.href = "/admin/products/add";
        }

        // Hàm xử lý khi nhấp vào nút sửa
        function editProduct(id) {
            window.location.href = "/admin/products/edit/" + id;
        }

        // Hàm xử lý khi nhấp vào nút xóa
        function deleteProduct(id) {
            if (confirm("Bạn có chắc chắn muốn xóa sản phẩm này không?")) {
                const xhr = new XMLHttpRequest();
                xhr.open("POST", "/admin/products/delete/" + id, true);
                xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
                xhr.onreadystatechange = function () {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            // Xóa sản phẩm thành công, có thể reload trang hoặc làm gì đó khác

                            location.reload()
                        } else {
                            console.error("Có lỗi xảy ra khi gửi yêu cầu xóa sản phẩm.");
                        }
                    }
                };
                xhr.send("id=" + id);
            }
        }

        // Xử lý sự kiện submit form tìm kiếm
        document.getElementById('search-form').addEventListener('input', function (event) {
            event.preventDefault(); // Ngăn chặn việc gửi yêu cầu tìm kiếm mặc định của form
            const query = document.getElementById('search-input').value;
            // Thực hiện tìm kiếm bằng cách gửi yêu cầu HTTP đến máy chủ và nhận kết quả
            performSearch(query);
        });

        // Hàm tìm kiếm
        function performSearch(query) {
            fetch('/admin/products/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({searchText: query}),
            })
                .then(response => response.json())
                .then(results => {
                    // Xóa bảng kết quả tìm kiếm cũ (nếu có)
                    document.getElementById('results-body').innerHTML = '';
                    // Hiển thị kết quả tìm kiếm mới
                    results.forEach(result => {
                        const row = document.createElement('tr');
                        let categoryName = "Không xác định"; // Giá trị mặc định
                        // Ánh xạ category_id sang category_name
                        switch (result.category_id) {
                            case 1:
                                categoryName = "Bánh mì";
                                break;
                            case 2:
                                categoryName = "Bánh ngọt";
                                break;
                            // Thêm các trường hợp khác nếu cần
                            default:
                                categoryName = "Bánh kem nhỏ";
                        }

                        row.innerHTML = `<td>${result.id}</td>
                                 <td>${result.name}</td>
                                 <td>${categoryName}</td>
                                 <td>${result.price}</td>
                                 <td>${result.discount}</td>
                                 <td>${result.stock}</td>
                                 <td>
                                        <div class="progress">
                                            <div class="progress-bar progress-bar-animated progress-bar-striped bg-success"
                                                role="progressbar"
                                                style="width: ${result.stock}%">
                                            </div>
                                        </div>
                                 </td>
                                 <td>${result.view}</td>
                                 <td class="operation-button">
                                    <button class="btn btn-danger" onclick="editProduct('${result.id}')">Sửa</button>
                                    <button class="btn btn-warning" onclick="deleteProduct('${result.id}')">Xóa</button>
                                 </td>`;
                        document.getElementById('results-body').appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Lỗi khi lấy kết quả tìm kiếm:', error);
                });
        }

    </script>
{% endblock %}