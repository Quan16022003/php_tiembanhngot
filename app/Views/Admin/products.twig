{% set page = 'products' %}
{% extends 'layout.twig' %}
{% block title %}Products{% endblock %}
{% block content %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center mb-1">
        <div class="input-group w-50">
            <form id="search-form">
                <input type="text" class="form-control" id="search-input" placeholder="Nhập từ khóa tìm kiếm"
                       style="width: 150px" aria-describedby="button-search">
                <button class="btn btn-outline-secondary" type="submit" id="button-search">Tìm kiếm</button>
            </form>
        </div>
        <a href="/admin/products/add" class="btn btn-success">Thêm</a>
    </div>
    <link rel="stylesheet" href="/public/css/admin_products.css">
    <div class="container">
        <table class="product-table">
            <thead>
            <tr>
                <th onclick="sortTable(0)">ID</th>
                <th onclick="sortTable(1)">Tên sản phẩm</th>
                <th onclick="sortTable(2)">Giá</th>
                <th onclick="sortTable(3)">Giảm giá</th>
                <th onclick="sortTable(4)">Link hình ảnh</th>
                <th onclick="sortTable(5)">Số lượng tồn kho</th>
                <th onclick="sortTable(6)">Ngày tạo</th>
                <th onclick="sortTable(7)">Lượt xem</th>
                <th>Thao tác</th>
            </tr>
            </thead>
            <tbody id="results-body">
            {% for product in products %}
                <tr>
                    <td>{{ product.id }}</td>
                    <td>{{ product.name }}</td>
                    <td>{{ product.price }}</td>
                    <td>{{ product.discount }}</td>
                    <td>{{ product.image_link }}</td>
                    <td>{{ product.stock }}</td>
                    <td>{{ product.created_at }}</td>
                    <td>{{ product.view }}</td>
                    <td class="operation-button">
                        <button class="btn edit-button" onclick="editProduct('{{ product.id }}')">Sửa</button>
                        <button class="btn delete-button" onclick="deleteProduct('{{ product.id }}')">Xóa</button>
                    </td>
                </tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
{% endblock %}
{% block scripts %}
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="/public/js/products.js"></script>
    <script>
        document.getElementById('search-form').addEventListener('submit', function (event) {
            event.preventDefault(); // Ngăn chặn việc gửi yêu cầu tìm kiếm mặc định của form

            const query = document.getElementById('search-input').value;

            // Thực hiện tìm kiếm bằng cách gửi yêu cầu HTTP đến máy chủ và nhận kết quả
            performSearch(query);
        });

        function performSearch(query) {
            fetch('/admin/products/search', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({searchText: query}),
            })
                .then(response => response.json())
                .then(results => {
                    // Xóa bảng kết quả tìm kiếm cũ (nếu có)
                    document.getElementById('results-body').innerHTML = '';

                    // Hiển thị kết quả tìm kiếm mới
                    results.forEach(result => {
                        const row = document.createElement('tr');
                        row.innerHTML = `<td>${result.id}</td><td>${result.name}</td>
                                         <td>${result.price}</td><td>${result.discount}</td>
                                         <td>${result.image_link}</td><td>${result.stock}</td>
                                         <td>${result.created_at}</td><td>${result.view}</td>
                                         <td class="operation-button">
                                            <button class="btn edit-button" onclick="editProduct('${result.id}')">Sửa</button>
                                            <button class="btn delete-button" onclick="deleteProduct('${result.id}')">Xóa</button>
                                         </td>`;
                        document.getElementById('results-body').appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Lỗi khi lấy kết quả tìm kiếm:', error);
                });
        }
    </script>
{% endblock %}
