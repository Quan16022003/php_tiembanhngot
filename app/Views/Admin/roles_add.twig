{% extends 'layout.twig' %}

{% block title %}Thêm quyền{% endblock %}

{% block content %}
    <div class="container">
        <form id="add-role-form">
            <div class="mb-3">
                <label for="name" class="form-label">Tên quyền</label>
                <input type="text" class="form-control" id="name" name="name" required>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-sm">
                    <thead>
                    <tr>
                        <th scope="col">Chức năng</th>
                        <th scope="col">Xem</th>
                        <th scope="col">Thêm</th>
                        <th scope="col">Sửa</th>
                        <th scope="col">Xóa</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for func in functions %}
                        <tr>
                            <td value="{{ func.id }}">{{ func.name }}</td>
                            <td><input type="checkbox" name="view"></td>
                            <td><input type="checkbox" name="add"></td>
                            <td><input type="checkbox" name="edit"></td>
                            <td><input type="checkbox" name="delete"></td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="d-flex justify-content-end flex-wrap flex-md-nowrap align-items-center mb-1">
                <button type="submit" class="btn btn-success">Thêm</button>
            </div>
        </form>
    </div>
{% endblock %}

{% block scripts %}
<script type="text/javascript">
    $(document).ready(function() {
        $('#add-role-form').submit(function(e) {
            e.preventDefault();

            const roleName = $('#name').val();
            let permissions = {};

            // Duyệt qua từng hàng trong bảng
            $('tbody tr').each(function() {
                var functionName = $(this).find('td:first-child').attr('value'); // Lấy tên chức năng

                // Lấy giá trị của các checkbox trong hàng hiện tại
                var viewPermission = $(this).find('input[name="view"]').is(':checked');
                var addPermission = $(this).find('input[name="add"]').is(':checked');
                var editPermission = $(this).find('input[name="edit"]').is(':checked');
                var deletePermission = $(this).find('input[name="delete"]').is(':checked');

                // Lưu trữ các giá trị vào đối tượng permissions
                permissions[functionName] = {
                    view: viewPermission,
                    add: addPermission,
                    edit: editPermission,
                    delete: deletePermission
                };
            });

            // Gửi AJAX request
            $.ajax({
                type: 'POST',
                url: '/admin/roles/add',
                data: {
                    name: roleName,
                    permissions: permissions
                },
                success: function(data) {
                    data = JSON.parse(data);
                    console.log(data);
                }
            })
        });
    });

</script>
{% endblock %}